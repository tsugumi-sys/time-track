<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Time Tracker</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap');

    :root {
      --bg: #f6f1ea;
      --bg-accent: #f2e6d8;
      --ink: #1c1a17;
      --muted: #6a625a;
      --card: #fffaf3;
      --stroke: #e0d4c4;
      --accent: #f39c12;
      --accent-dark: #c26c00;
      --accent-soft: rgba(243, 156, 18, 0.12);
      --shadow: 0 22px 45px -35px rgba(24, 18, 12, 0.5);
      --radius: 20px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Space Grotesk', sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at top left, rgba(243, 156, 18, 0.15), transparent 45%),
        radial-gradient(circle at 20% 85%, rgba(109, 93, 78, 0.2), transparent 50%),
        linear-gradient(135deg, var(--bg), var(--bg-accent));
      min-height: 100vh;
    }

    header {
      padding: 48px 0 24px;
    }

    .container {
      width: min(1100px, 92vw);
      margin: 0 auto;
    }

    .title {
      font-size: clamp(2rem, 3.5vw, 3.2rem);
      font-weight: 700;
      letter-spacing: -0.02em;
      margin: 0 0 8px;
    }

    .subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 1rem;
    }

    .grid {
      display: grid;
      gap: 20px;
    }


    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin: 24px 0 12px;
    }

    .segmented {
      display: inline-flex;
      border-radius: 999px;
      background: #efe2d1;
      border: 1px solid var(--stroke);
      padding: 4px;
      gap: 4px;
    }

    .segmented button {
      border: none;
      background: transparent;
      padding: 8px 16px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .segmented button.active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 10px 18px -10px rgba(0, 0, 0, 0.4);
    }

    .section {
      margin: 28px 0 36px;
    }

    .section h2 {
      margin: 0 0 16px;
      font-size: 1.4rem;
      font-weight: 600;
    }

    .chart {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .chart svg {
      width: 100%;
      height: 240px;
      display: block;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .legend i {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    .tag-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    .tag-table th,
    .tag-table td {
      padding: 10px 8px;
      text-align: left;
      border-bottom: 1px solid var(--stroke);
    }

    .tag-table th {
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .bar {
      height: 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      position: relative;
      overflow: hidden;
    }

    .bar span {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-dark));
      border-radius: 999px;
    }

    .meta {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .empty {
      padding: 20px;
      text-align: center;
      color: var(--muted);
    }

    @keyframes rise {
      from {
        opacity: 0;
        transform: translateY(14px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 720px) {
      header {
        padding: 32px 0 16px;
      }

      .controls {
        flex-direction: column;
        align-items: flex-start;
      }

      .chart svg {
        height: 200px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1 class="title">Time Tracker</h1>
      <p class="subtitle">Git commit-driven tracking with normalized tags.</p>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <div class="controls">
        <div class="segmented" id="period-toggle">
          <button type="button" data-period="week" class="active">Week</button>
          <button type="button" data-period="month">Month</button>
          <button type="button" data-period="year">Year</button>
        </div>
        <div class="meta" id="period-range">--</div>
      </div>
    </section>

    <section class="section">
      <h2>Tag Trends</h2>
      <div class="chart" id="trend-chart">
        <svg viewBox="0 0 1000 240" preserveAspectRatio="none"></svg>
        <div class="legend" id="trend-legend"></div>
      </div>
    </section>

    <section class="section">
      <h2>Tag Breakdown</h2>
      <div class="chart">
        <table class="tag-table" id="tag-table">
          <thead>
            <tr>
              <th>Tag</th>
              <th>Hours</th>
              <th>Share</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="empty" id="tag-empty" hidden>No data yet.</div>
      </div>
    </section>
  </main>

  <script>
    const state = {
      report: null,
      period: 'week'
    };

    const numberFormatter = new Intl.NumberFormat('en-US', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });

    function setPeriod(period) {
      state.period = period;
      document.querySelectorAll('#period-toggle button').forEach((btn) => {
        btn.classList.toggle('active', btn.dataset.period === period);
      });

      const { start, end } = state.report.periods[period];
      document.getElementById('period-range').textContent = `${start} â†’ ${end}`;

      renderTags();
      renderTrend();
    }

    function renderTags() {
      const tbody = document.querySelector('#tag-table tbody');
      tbody.innerHTML = '';
      const empty = document.getElementById('tag-empty');

      const totals = state.report.by_primary[state.period] || {};
      const entries = Object.entries(totals).sort((a, b) => b[1] - a[1]);
      if (entries.length === 0) {
        empty.hidden = false;
        return;
      }
      empty.hidden = true;
      const maxValue = Math.max(...entries.map(([, value]) => value));

      for (const [tag, hours] of entries) {
        const row = document.createElement('tr');
        const share = maxValue === 0 ? 0 : (hours / maxValue) * 100;
        row.innerHTML = `
          <td>${tag}</td>
          <td>${numberFormatter.format(hours)}</td>
          <td>
            <div class="bar"><span style="width:${share.toFixed(1)}%"></span></div>
          </td>
        `;
        tbody.appendChild(row);
      }
    }

    function getTagKeys(series) {
      const keys = new Set();
      for (const row of series) {
        for (const key of Object.keys(row)) {
          if (key !== 'date' && key !== 'total') {
            keys.add(key);
          }
        }
      }
      return Array.from(keys);
    }

    function renderTrend() {
      const svg = document.querySelector('#trend-chart svg');
      const legend = document.getElementById('trend-legend');
      svg.innerHTML = '';
      legend.innerHTML = '';

      const series = state.report.daily_series || [];
      const tags = getTagKeys(series);
      if (series.length === 0 || tags.length === 0) {
        svg.innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#6a625a">No data yet</text>';
        return;
      }

      const palette = [
        '#f39c12',
        '#2f80ed',
        '#27ae60',
        '#e84393',
        '#6c5ce7',
        '#00b894',
        '#d35400',
        '#1abc9c'
      ];

      const values = [];
      for (const row of series) {
        for (const tag of tags) {
          values.push(row[tag] || 0);
        }
      }
      const maxValue = Math.max(...values, 1);

      tags.forEach((tag, index) => {
        const points = series.map((row, rowIndex) => {
          const x = (rowIndex / (series.length - 1 || 1)) * 1000;
          const y = 220 - ((row[tag] || 0) / maxValue) * 180;
          return `${x},${y}`;
        });

        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const color = palette[index % palette.length];
        path.setAttribute('d', `M ${points.join(' L ')}`);
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', color);
        path.setAttribute('stroke-width', '3');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        svg.appendChild(path);

        const legendItem = document.createElement('span');
        legendItem.innerHTML = `<i style="background:${color}"></i>${tag}`;
        legend.appendChild(legendItem);
      });
    }

    async function loadReport() {
      try {
        const response = await fetch('assets/report.json', { cache: 'no-store' });
        if (!response.ok) throw new Error('failed');
        const report = await response.json();
        state.report = report;
        setPeriod(state.period);
      } catch (error) {
        document.getElementById('trend-chart').innerHTML = '<div class="empty">Report data not found yet.</div>';
        document.getElementById('tag-empty').hidden = false;
      }
    }

    document.getElementById('period-toggle').addEventListener('click', (event) => {
      if (event.target.tagName !== 'BUTTON') return;
      setPeriod(event.target.dataset.period);
    });

    loadReport();
  </script>
</body>
</html>
